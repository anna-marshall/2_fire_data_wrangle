---
title: "Hayman Fire Recovery"
author: "Anna Marshall"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, warning=F,message=F}
library(tidyverse)
library(tidyr)
library(ggthemes)
library(lubridate)

# Now that we have learned how to munge (manipulate) data
# and plot it, we will work on using these skills in new ways

knitr::opts_knit$set(root.dir='..')
```

```{r dataread, warning=F,message=F}
#Reading in files
files <- list.files('data',full.names=T)


#files

#Read in individual data files
ndmi <- read_csv(files[1]) %>% 
  rename(burned=2,unburned=3) %>%
  mutate(data='ndmi')


ndsi <- read_csv(files[2]) %>% 
  rename(burned=2,unburned=3) %>%
  mutate(data='ndsi')

ndvi <- read_csv(files[3])%>% 
  rename(burned=2,unburned=3) %>%
  mutate(data='ndvi')

#Use view to look at a data like you would in excel
View(ndmi)


## join all datasets together and rename columns
full_wide <- inner_join(ndmi %>% dplyr::select(-data),
                        ndvi %>% dplyr::select(-data),
                        by='DateTime') %>%
  inner_join(ndsi %>% dplyr::select(-data),by='DateTime') %>%
  rename(burned_ndmi = 2,unburned_ndmi=3,
         burned_ndvi=4, unburned_ndvi=5,
         burned_ndsi=6, unburned_ndsi=7) %>%
  filter_if(is.numeric,all_vars(!is.na(.))) %>%
  mutate(month=month(DateTime),
         year = year(DateTime))

## Plot of burned plots of moisture (ndmi) vs greenness (ndvi)
full_wide %>%
  filter(!month %in% c(11,12,1,2,3,4,5)) %>%
ggplot(.,aes(x=burned_ndmi,y=burned_ndvi,color=month)) + 
  geom_point()
View(full_wide)

# Stack as a tidy dataset
full_long <- rbind(ndvi,ndmi,ndsi) %>%
  gather(key='site',value='value',-DateTime,-data) %>%
  filter(!is.na(value))
View(full_long)


# Plot all three different types
ggplot(full_long,aes(x=DateTime,y=value,color=site)) + 
  geom_line() + 
  facet_wrap(~data)+
  theme_few() + 
  scale_color_few() 

```
##Q1. Correlation between NDVI and NDMI
```{r}
##convert full_long dataset to wide format
data_wide<-spread(full_long,data,value)%>%
  mutate(month=month(DateTime),
         year = year(DateTime),
         treatment = cut(year,breaks=c(0,2003,2020),
                         labels=c('pre-burn','post-burn')))
        

## Plot of moisture (ndmi) vs greenness (ndvi) for burned area
data_wide %>%
  filter(!month %in% c(11,12,1,2,3,4,5)) %>%
ggplot(.,aes(x=ndmi,y=ndvi,color=month)) + 
  geom_point()+
  facet_wrap(~site)+
  theme_few()

```

##Q2. Correlation between average NDSI (January-April) and NDVI (June-August)
```{r}
## Plot of snow (ndsi) vs greenness (ndvi) 
data_wide %>%
  filter(!month %in% c(5,9,10,11,12)) %>%
ggplot(.,aes(x=ndvi,y=ndsi,color=month)) + 
  geom_point()+
  theme_few()
```



## Q3. Comparing snow effect between burned vs. unburned and pre- vs. post-burn.
```{r}
## Plot of snow (ndsi) vs greenness (ndvi) seperated by burned vs. unburned
data_wide %>%
  filter(!month %in% c(5,9,10,11,12)) %>%
ggplot(.,aes(x=ndvi,y=ndsi,color=month)) + 
  geom_point()+
  facet_wrap(~site)+
  theme_few()

## Plot of snow (ndsi) vs greenness (ndvi) seperated by pre- vs. post-burn
##Using 1984-2001 as pre-burn and 2002-2019 as post-burn
data_wide %>%
  filter(!month %in% c(5,9,10,11,12)) %>%
ggplot(.,aes(x=ndvi,y=ndsi,color=month)) + 
  geom_point()+
  facet_wrap(~treatment)+
  theme_few()


```

## Q4. What month is the greenest month on average? 
```{r}
# Plotting seasonal variation by summarizing over month instead of year
ndvi_month <- ndvi_long %>%
  mutate(year=year(DateTime)) %>%
  mutate(month=month(DateTime)) %>%
  group_by(site,month) %>%
  summarize(mean_NDVI=mean(NDVI))

# Same plot as above but with month on x-axis
ggplot(ndvi_month,aes(x=month,y=mean_NDVI,color=site)) +
  geom_point(shape=1) + 
  geom_line() +
  theme_few() + 
  scale_color_few() + 
  scale_x_continuous(breaks=seq(1,12,1))+
  theme(legend.position=c(0.6,0.2))
```




## Q5. What month is the snowiest on average?
```{r}
#Reading in the data. 
ndsi <- read_csv('data/hayman_ndsi.csv') %>%
  rename(burned=2,unburned=3) %>%
  filter(!is.na(burned),
         !is.na(unburned))

# Converting from wide to long data
ndsi_long <- gather(ndsi,
                    key='site',
                    value='NDSI',
                    -DateTime)
# Plotting seasonal variation by summarizing over month instead of year
ndsi_month <- ndsi_long %>%
  mutate(year=year(DateTime)) %>%
  mutate(month=month(DateTime)) %>%
  group_by(site,month) %>%
  summarize(mean_NDSI=mean(NDSI))

# Same plot as above but with month on x-axis
ggplot(ndsi_month,aes(x=month,y=mean_NDSI,color=site)) +
  geom_point(shape=1) + 
  geom_line() +
  theme_few() + 
  scale_color_few() + 
  scale_x_continuous(breaks=seq(1,12,1))+
  theme(legend.position=c(0.6,0.2))
```



## Bonus Question: Redo all problems with `spread` and `gather` using modern tidyverse syntax. 
Modern tidyverse syntax uses pivot_wider() and pivot_longer() to reshape data between wide and long formats. Check out the updated code below that utilizes this modern tidyverse syntax. 
```{r}
#convert wide data to long
long_pivot <- rbind(ndvi,ndmi,ndsi) %>%
  pivot_longer(cols=c('burned','unburned'),names_to = "site", values_to = "value") %>%
  filter(!is.na(value))

#convert long data to wide
wide_pivot<-pivot_wider(full_long,names_from = "site", values_from = "value")%>%
  mutate(month=month(DateTime),
         year = year(DateTime),
         treatment = cut(year,breaks=c(0,2003,2020),
                         labels=c('pre-burn','post-burn')))
```

## Bonus Question: Use Climage Engine to pull the same data for the assignment, but updated with 2020/2021 data.
Data has been updated in all graphs to include 2020/2021 data for NDVI, NDSI, and NDMI. 



